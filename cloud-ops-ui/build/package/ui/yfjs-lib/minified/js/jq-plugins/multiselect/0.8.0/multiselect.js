define(["jquery"],function(a){var b=function(a){return"number"==typeof a||/^\d+(\.\d+)?$/.test(a)},c=function(b,d){this.$element=a(b),d=d&&"object"==typeof d?d:{},this.options=a.extend({},c.DEFAULTS,d),this.options.toColumn=a.extend({},c.DEFAULTS.toColumn,d.toColumn),this.options.fromColumn=a.extend({},c.DEFAULTS.fromColumn,d.fromColumn),this.bindEvents(),this.create(),this.handleEvents()};c.VERSION="0.8.0",c.DATA_KEY="item.multiselect",c.INST_KEY="ui.multiselect",c.TYPE_SELECTED="selected",c.TYPE_UNSELECTED="unselected",c.DEFAULTS={height:"auto",minHeight:300,maxHeight:400,toColumn:{title:"已选栏",cssClass:"col-sm-6",items:[],loadMore:null},fromColumn:{title:"可选栏",cssClass:"col-sm-6",items:[],loadMore:null},dataSrc:null,oncreated:null,onchanged:null,onselected:null,ondeselected:null},c.DEFAULTS.ITEM={name:"",icon:!0},c.ITEM=function(b){var d=this;"string"==typeof b?(this.originalData=b,a.each(c.DEFAULTS.ITEM,function(a,c){"name"==a?d[a]=b:d[a]=c})):(this.originalData=b?a.extend({},b):b,b=a.extend({},c.DEFAULTS.ITEM,b),a.each(b,function(a,b){d[a]=b}))},c.prototype.bindEvents=function(){return this.$element.off("created.multiselect").on("created.multiselect",a.proxy(function(b){if(!this.options.fromColumn.items||this.options.fromColumn.items.length<=0){var c='<div class="alert alert-info" style="margin: 0 5px;">无可添加项</div>';a(".multiselect-column-list",a(".multiselect-column-from",a(b.currentTarget))).append(c)}"function"==typeof this.options.oncreated&&this.options.oncreated.apply(this,arguments)},this)),this.$element.off("changed.multiselect").on("changed.multiselect",a.proxy(function(b){"function"==typeof this.options.onchanged&&(b.data=a(b.relatedTarget).data(c.DATA_KEY).originalData,this.options.onchanged.apply(this,arguments))},this)),this.$element.off("selected.multiselect").on("selected.multiselect",a.proxy(function(b){"function"==typeof this.options.onselected&&(b.data=a(b.relatedTarget).data(c.DATA_KEY).originalData,this.options.onselected.apply(this,arguments))},this)),this.$element.off("deselected.multiselect").on("deselected.multiselect",a.proxy(function(b){var d=a(".multiselect-column-list",a(".multiselect-column-from",a(b.currentTarget))).find(".alert");d.length&&d.remove(),"function"==typeof this.options.ondeselected&&(b.data=a(b.relatedTarget).data(c.DATA_KEY).originalData,this.options.ondeselected.apply(this,arguments))},this)),this},c.prototype.create=function(){var b=this.options,d=a('<fieldset class="multiselect-column-to"><legend class="multiselect-column-title">'+b.toColumn.title+'</legend><div class="multiselect-column-filter"><i class="multiselect-icon-search"></i><input class="form-control" type="search" /></div><ul class="multiselect-column-list"></ul></fieldset>'),e=a('<fieldset class="multiselect-column-from"><legend class="multiselect-column-title">'+b.fromColumn.title+'</legend><div class="multiselect-column-filter"><i class="multiselect-icon-search"></i><input class="form-control" type="search" /></div><ul class="multiselect-column-list"></ul></fieldset>');d.addClass(b.toColumn.cssClass);var f=a(".multiselect-column-list",d),g=this.createItems(b.toColumn.items,c.TYPE_SELECTED);f.append(g),e.addClass(b.fromColumn.cssClass);var h=a(".multiselect-column-list",e),i=this.createItems(b.fromColumn.items,c.TYPE_UNSELECTED);return h.append(i),this.$element.empty().append(e).append(d),this.$toColumn=a(".multiselect-column-to",this.$element),this.$toList=a(".multiselect-column-list",this.$toColumn),this.createMoreItem(c.TYPE_SELECTED),this.$fromColumn=a(".multiselect-column-from",this.$element),this.$fromList=a(".multiselect-column-list",this.$fromColumn),this.createMoreItem(c.TYPE_UNSELECTED),this.orgSelectedItems=this.getSelectedItems(),b.height&&"auto"!==b.height?this.setHeight():(this.setMinHeight(),this.setMaxHeight()),this.$element.trigger(a.Event("created.multiselect")),this},c.prototype.createItem=function(b,d){if(b&&b.name){var e,f,g;return d===c.TYPE_SELECTED?(f="delete",g="移除",e="双击移除"):(f="add",g="选择",e="双击选择"),a('<li class="multiselect-column-item">'+(b.icon?'<i class="multiselect-icon-'+f+'" title="'+g+'"></i>':"")+'<a title="'+e+'">'+b.name+"</a></li>").data(c.DATA_KEY,b)}return a([])},c.prototype.createItems=function(b,d){b=b||[];var e=this,f=a([]);return a.each(b,function(a,b){f=f.add(e.createItem(new c.ITEM(b),d))}),f},c.prototype.createMoreItem=function(a){return a===c.TYPE_SELECTED&&this.options.toColumn.loadMore?this.$toList.children(".multiselect-column-more").length<=0&&this.$toList.append('<li class="multiselect-column-more"><a href="javascript:;">加载更多</a></li>'):a===c.TYPE_UNSELECTED&&this.options.fromColumn.loadMore&&this.$fromList.children(".multiselect-column-more").length<=0&&this.$fromList.append('<li class="multiselect-column-more"><a href="javascript:;">加载更多</a></li>'),this},c.prototype.handleEvents=function(){var b=this;this.$toColumn.find('input[type="search"]').on("keypress.multiselect",function(a){13==a.keyCode&&b.searchTo()}),this.$toColumn.find(".multiselect-icon-search").on("click.multiselect",function(){b.searchTo()}),this.$fromColumn.find('input[type="search"]').on("keypress.multiselect",function(a){13==a.keyCode&&b.searchFrom()}),this.$fromColumn.find(".multiselect-icon-search").on("click.multiselect",function(){b.searchFrom()});var d=function(d){var e=b.createItem(d.data(c.DATA_KEY),c.TYPE_SELECTED);b.$toList.prepend(e),d.remove(),b.$element.trigger(a.Event("selected.multiselect",{relatedTarget:e[0]})),b.isChanged()&&b.$element.trigger(a.Event("changed.multiselect",{relatedTarget:e[0]}))},e=function(d){var e=b.createItem(d.data(c.DATA_KEY),c.TYPE_UNSELECTED);b.$fromList.prepend(e),d.remove(),b.$element.trigger(a.Event("deselected.multiselect",{relatedTarget:e[0]})),b.isChanged()&&b.$element.trigger(a.Event("changed.multiselect",{relatedTarget:e[0]}))};return this.$toList.on("dblclick.multiselect",".multiselect-column-item>a",function(){e(a(this).parents("li:first"))}),this.$toList.on("click.multiselect",".multiselect-icon-delete",function(){e(a(this).parents("li:first"))}),this.$fromList.on("dblclick.multiselect",".multiselect-column-item>a",function(){d(a(this).parents("li:first"))}),this.$fromList.on("click.multiselect",".multiselect-icon-add",function(){d(a(this).parents("li:first"))}),this.$toList.on("click.multiselect",".multiselect-column-more>a",this,function(b){return!a(this).parent().hasClass("done")&&!a(this).parent().hasClass("loading")&&void b.data.loadMoreTo()}),this.$fromList.on("click.multiselect",".multiselect-column-more>a",this,function(b){return!a(this).parent().hasClass("done")&&!a(this).parent().hasClass("loading")&&void b.data.loadMoreFrom()}),this},c.prototype.setHeight=function(a){return"undefined"==typeof a&&(a=this.options.height),this.$toList.css("height",a+(b(a)?"px":"")),this.$fromList.css("height",a+(b(a)?"px":"")),this},c.prototype.setMinHeight=function(a){return"undefined"==typeof a&&(a=this.options.minHeight),this.$toList.css("minHeight",a+(b(a)?"px":"")),this.$fromList.css("minHeight",a+(b(a)?"px":"")),this},c.prototype.setMaxHeight=function(a){return"undefined"==typeof a&&(a=this.options.maxHeight),this.$toList.css("maxHeight",a+(b(a)?"px":"")),this.$fromList.css("maxHeight",a+(b(a)?"px":"")),this},c.prototype.isChanged=function(){if(this.orgSelectedItems){var a=this.getSelectedItems();if(this.orgSelectedItems.length!=a.length)return!0;for(var b in a)if(this.orgSelectedItems.indexOf(a[b])<0)return!0}return!1},c.prototype.searchTo=function(b){return"undefined"==typeof b&&(b=this.$toColumn.find('input[type="search"]').val()),this.$toList.children(".multiselect-column-item").each(function(){var d=a(this),e=d.data(c.DATA_KEY);b&&e.name.indexOf(b)<0?d.hide():d.show(),e=null,d=null}),this},c.prototype.searchFrom=function(b){return"undefined"==typeof b&&(b=this.$fromColumn.find('input[type="search"]').val()),this.$fromList.children(".multiselect-column-item").each(function(){var d=a(this),e=d.data(c.DATA_KEY);b&&e.name.indexOf(b)<0?d.hide():d.show(),e=null,d=null}),this},c.prototype.loadMoreTo=function(){var b=this;if("function"==typeof this.options.toColumn.loadMore){var c=this.loadedNumTo,d=this.options.toColumn.loadMore.call(this,c);d&&"function"==typeof d.done?(this.loadingMoreTo(),d.done(function(c){a.isArray(c)&&c.length?(b.loadedMoreTo(c.length),b.addSelectedItems(c)):b.doneMoreTo()}).fail(function(){b.errorMoreTo.apply(b,arguments)})):b.doneMoreTo()}return this},c.prototype.loadMoreFrom=function(){var b=this;if("function"==typeof this.options.fromColumn.loadMore){var c=this.loadedNumFrom,d=this.options.fromColumn.loadMore.call(this,c);d&&"function"==typeof d.done?(this.loadingMoreFrom(),d.done(function(c){a.isArray(c)&&c.length?(b.loadedMoreFrom(c),b.addUnSelectedItems(c)):b.doneMoreFrom()}).fail(function(){b.errorMoreFrom.apply(b,arguments)})):b.doneMoreFrom()}return this},c.prototype.loadingMoreTo=function(){return this.$toList.find(".multiselect-column-more").removeClass("error").addClass("loading").children("a").text("正在加载..."),this},c.prototype.loadingMoreFrom=function(){return this.$fromList.find(".multiselect-column-more").removeClass("error").addClass("loading").children("a").text("正在加载..."),this},c.prototype.loadedMoreTo=function(a){return this.loadedNumTo=this.loadedNumTo||0,"number"==typeof a&&a>=0&&(this.loadedNumTo+=a),this.$toList.find(".multiselect-column-more").removeClass("loading").children("a").text("加载更多"),this},c.prototype.loadedMoreFrom=function(a){return this.loadedNumFrom=this.loadedNumFrom||0,"number"==typeof a&&a>=0&&(this.loadedNumFrom+=a),this.$fromList.find(".multiselect-column-more").removeClass("loading").children("a").text("加载更多"),this},c.prototype.errorMoreTo=function(){return this.$toList.find(".multiselect-column-more").removeClass("loading").addClass("error").children("a").text("加载失败！点击重新加载"),this},c.prototype.errorMoreFrom=function(){return this.$fromList.find(".multiselect-column-more").removeClass("loading").addClass("error").children("a").text("加载失败！点击重新加载"),this},c.prototype.doneMoreTo=function(){return this.$toList.find(".multiselect-column-more").removeClass("loading loaded error").addClass("done").children("a").text("没有更多项了"),this},c.prototype.doneMoreFrom=function(){return this.$fromList.find(".multiselect-column-more").removeClass("loading loaded error").addClass("done").children("a").text("没有更多项了"),this},c.prototype.addSelectedItems=function(a){var b=this.createItems(a,c.TYPE_SELECTED);return this.$toList.children(".multiselect-column-item:last").after(b),this},c.prototype.addUnSelectedItems=function(a){var b=this.createItems(a,c.TYPE_UNSELECTED);return this.$fromList.children(".multiselect-column-item:last").after(b),this},c.prototype.setSelectedItems=function(a){var b=this.createItems(a,c.TYPE_SELECTED);return this.$toList.empty().append(b),this.createMoreItem(c.TYPE_SELECTED),this},c.prototype.setUnSelectedItems=function(a){var b=this.createItems(a,c.TYPE_UNSELECTED);return this.$fromList.empty().append(b),this.createMoreItem(c.TYPE_UNSELECTED),this},c.prototype.getSelectedItems=function(){var b,d=[];return this.$toList.children(".multiselect-column-item").each(function(){b=a(this).data(c.DATA_KEY),b&&d.push(b)}),d},c.prototype.getSelectedData=function(){var b=this,c=[],d=this.getSelectedItems();return a.each(d,function(a,d){c.push(b._getDataSource(d.originalData))}),c},c.prototype.getUnSelectedItems=function(){var b,d=[];return this.$fromList.children(".multiselect-column-item").each(function(){b=a(this).data(c.DATA_KEY),b&&d.push(b)}),d},c.prototype.getUnSelectedData=function(){var b=this,c=[],d=this.getUnSelectedItems();return a.each(d,function(a,d){c.push(b._getDataSource(d.originalData))}),c},c.prototype._getDataSource=function(b){if(!b||!this.options.dataSrc||"object"!=typeof b)return b;var c;return"object"==typeof this.options.dataSrc?a.each(this.options.dataSrc,function(a,d){!c&&(c={}),c[d]=b[d]}):c=b[this.options.dataSrc],c};var d=a.fn.multiSelect;return a.fn.multiSelect=function(b){var d,e=a(this);if((d=e.data(c.INST_KEY))||e.data(c.INST_KEY,d=new c(this,b)),"string"==typeof b&&d){var f=d[b];if("function"==typeof f){var g=Array.prototype.slice.call(arguments,1);return f.apply(d,g)}throw"MultiSelect Error: Method "+f+" does not exist"}return this},a.fn.multiSelect.Constructor=c,a.fn.multiSelect.noConflict=function(){return a.fn.multiSelect=d,this},c});